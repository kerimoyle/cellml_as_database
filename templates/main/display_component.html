{% extends 'main/base.html' %}
{% load crispy_forms_tags %}
{% load foe_tags %}

{% block title %}{{ item_type }} <b>{{ item.name }}</b>{% endblock title %}

{% block todo %}{% endblock todo %}

{% block tabs %}
    {{ block.super }}

    <ul class="nav nav-tabs">
        <li class="active"><a data-toggle="tab" href="#tab_information">Summary</a></li>
        {% for field, obj_type, objs, title in data %}
            <li><a data-toggle="tab" href="#tab_{{ field }}">{{ title }}</a></li>
        {% endfor %}
        <li><a data-toggle="tab" href="#tab_validity">Validity and checking</a></li>
    </ul>

{% endblock tabs %}

{% block content %}

    <div class="tab-content">

        <div id="tab_information" class="tab-pane fade in active">
            <br>
            {% if item.notes %}<p>{{ item.notes|linebreaks }}</p>
            {% else %}<p class="empty">No notes provided</p>{% endif %}

            <table class="datatables display table" id="table-information">
                <thead>
                <tr>
                    <th>Name</th>
                    <th>Value</th>
                </tr>
                </thead>
                <tbody>
                {% for field, obj in locals %}
                    <tr>
                        <td>{{ field }}</td>
                        <td>
                            {% if obj %}{{ obj }}
                            {% else %}<p class="empty">None</p>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
                <tr>
                    <td>owner</td>
                    <td>
                        {% if item.owner %}{{ item.owner|title }}
                        {% else %}
                            <p class="empty">None</p>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td>provenance</td>
                    <td>
                        {% if item.imported_from %}{{ item.imported_from }}
                        {% else %}
                            <p class="empty">None</p>
                        {% endif %}
                    </td>
                </tr>
                </tbody>
            </table>


        </div>

        {% for field_name, obj_type, objs, title in data %}

            <div id="tab_{{ field_name }}" class="tab-pane fade">
                <br>
                <div class="button_bar">
                    <a onclick="LoadModalData('Include {{ field_name }}',
                            '{% url 'main:link_downstream' item_type=item_type item_id=item.id related_name=field_name %}'
                            );"
                       data-toggle="modal"
                       data-target="#formModal"
                       style="text-decoration: none;">
                        <button class="btn btn-default">
                            <i class="fa fa-chain"></i> Include existing {{ obj_type }}
                        </button>
                    </a>
                    <a href="{% url 'main:create' item_type=obj_type %}" target="_blank">
                        <button id="add_new_{{ obj_type }}" class="btn btn-default">
                            <i class="fa fa-plus"></i> Create a new {{ obj_type }}
                        </button>
                    </a>
                </div>
                <table class="datatables display table table-hover" id="table-{{ obj_type }}" width="100%">
                    <thead>
                    <tr>
                        <th>Name</th>
                        <th>Owner</th>
                        {% if can_edit %}
                            <th>Actions</th>
                        {% endif %}
                    </tr>
                    </thead>
                    <tbody class="rowlink" data-link="row">
                    {% for obj in objs %}
                        <tr>
                            <td>
                                <a href="{% url 'main:display' item_type=field_name item_id=obj.id %}"></a>
                                {{ obj.name }}
                            </td>
                            <td>{{ obj.owner }}</td>
                            {% if can_edit %}
                                <td class="rowlink-skip">
                                    <a onclick="Unlink('{{ field_name }}','{{ obj.id }}');">Unlink</a>
                                </td>
                            {% endif %}
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        {% endfor %}

        <div id="tab_validity" class="tab-pane fade">
            <div class="button_bar">
                <button id="check_validity" class="btn btn-default">
                    <i class="fa fa-refresh"></i> Check again
                </button>

                <a href="{% url 'main:show_errors' item_type=item_type item_id=item.id %}">
                    <button class="btn btn-default">
                        <i class="fa fa-list"></i> Show TODO list
                    </button>
                </a>
            </div>

            <div class="col-sm-12">

                <b>Last checked: </b><span id="last_checked">{{ item.last_checked }}</span>
                <div id="validity_div" class="validity_{{ item.is_valid }}">
                    <div id="errors">
                        {% for e in item.errors.all %}
                            {{ e.spec }}: {{ e.hints|safe }}<br>
                        {% empty %}
                            There are no local validation errors, but downstream entities contain errors.  Use the
                            <i>Show TODO list</i> to see them.
                        {% endfor %}
                    </div>
                </div>
            </div>
            {##}
            {#            <table class="datatables display table">#}
            {#                <thead>#}
            {#                <th>Field</th>#}
            {#                <th>Value</th>#}
            {#                <th colspan="2">Validity</th>#}
            {#                <th></th>#}
            {#                </thead>#}
            {#                <tbody>#}
            {##}
            {#                {% for f in item_fields %}#}
            {#                    <tr id="v_{{ f }}_symbol">#}
            {#                        <td>{{ f }}</td>#}
            {#                        <td>{% getattribute item f %}</td>#}
            {#                        <td>#}
            {#                                <div id="v_{{ f }}_symbol"></div>#}
            {#                        </td>#}
            {#                        <td>#}
            {#                            <div id="v_{{ f }}"></div>#}
            {#                        </td>#}
            {#                        <td>#}
            {#                            <a onclick="LoadModalData(#}
            {#                                    'Edit {{ f }}',#}
            {#                                    '{% url 'main:link_upstream' item_type='reset' item_id=item.id related_name=f %}'#}
            {#                                    );"#}
            {#                               data-toggle="modal"#}
            {#                               data-target="#formModal"#}
            {#                               style="text-decoration: none;">#}
            {#                                Change#}
            {#                            </a>#}
            {#                        </td>#}
            {#                    </tr>#}
            {#                {% endfor %}#}
            {##}
            {#                </tbody>#}
            {#            </table>#}
            {##}

        </div>


    </div>
    {##}
    {##}
    {#    <div id="validity" class="tab-pane fade">#}
    {#        <div class="row">#}
    {#            <div class="col-sm-3">#}
    {#                <h3>Validity</h3>#}
    {#            </div>#}
    {##}
    {#        </div>#}
    {##}
    {#        <div class="row">#}
    {#            <div class="col-sm-12">#}
    {#                <h3>Information</h3>#}
    {#            </div>#}
    {#        </div>#}
    {##}
    {#        <p class="info"><b>Local</b> attributes are those specifically owned by this type of object, ie:#}
    {#            the {{ item_type }}.#}
    {#            These are distinct from links or connections to other objects, which are shown in the#}
    {#            other columns. You can edit the local attributes of any items which you own by clicking the <b>Edit</b>#}
    {#            button at the bottom of the list.<br><br>#}
    {#            If you need to edit the local attributes of an item which you don't own, you will need to first create#}
    {#            your own copy using the <b>Send to my library</b> button.#}
    {#        </p>#}
    {##}
    {#    </div>#}
    {#    <div id="tab3" class="tab-pane fade">#}
    {#        <div class="row">#}
    {#            <div class="col-sm-6">#}
    {#                <h3>Downstream</h3>#}
    {#            </div>#}
    {#            {% if can_edit %}#}
    {#                <div class="col-sm-6 button_bar" style="padding-top:15px;">#}
    {#                    <div class="dropdown">#}
    {#                        <button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown">#}
    {#                            <i class="fa fa-chain"></i> Add link to ...#}
    {#                            <span class="caret"></span></button>#}
    {#                        <ul class="dropdown-menu dropdown-menu-right">#}
    {#                            {% for r in downstream_fields %}#}
    {#                                <li>#}
    {#                                    <a onclick="LoadModalData('Create link',#}
    {#                                            '{% url 'main:link_downstream' item_type=item_type item_id=item.id related_name=r %}'#}
    {#                                            );"#}
    {#                                       data-toggle="modal"#}
    {#                                       data-target="#formModal"#}
    {#                                       style="text-decoration: none;">#}
    {#                                        {{ r }}#}
    {#                                    </a>#}
    {#                                </li>#}
    {#                            {% endfor %}#}
    {#                        </ul>#}
    {#                    </div>#}
    {#                </div>#}
    {#            {% endif %}#}
    {#        </div>#}
    {#        <p class="info">#}
    {#            <b>Downstream</b> items are the children or dependants of the current item. Clicking on a row in the#}
    {#            table below will open the detailed description page for each of the related items. To remove an#}
    {#            external connection, click the <b>Unlink</b> button on that row. To add a new connection, click the#}
    {#            <b>Add link to</b> button.#}
    {#        </p>#}
    {#        <table class="datatables display table table-hover" id="table-connections">#}
    {#            <thead>#}
    {#            <tr>#}
    {#                <th>Type</th>#}
    {#                <th>Name</th>#}
    {#                <th>Owner</th>#}
    {#                {% if can_edit %}#}
    {#                    <th></th>#}
    {#                {% endif %}#}
    {#            </tr>#}
    {#            </thead>#}
    {#            <tbody class="rowlink" data-link="row">#}
    {#            {% for field, type, obj in downstream %}#}
    {#                {% if obj %}#}
    {#                    <tr>#}
    {#                        <td>#}
    {#                            <a href="{% url 'main:display' item_type=type item_id=obj.id %}"></a>#}
    {#                            {{ field }}#}
    {#                        </td>#}
    {#                        <td>{{ obj }}</td>#}
    {#                        <td>{{ obj.owner }}</td>#}
    {#                        {% if can_edit %}#}
    {#                            <td class="rowlink-skip">#}
    {#                                <a onclick="Unlink('{{ field }}','{{ obj.id }}');">Unlink</a>#}
    {#                            </td>#}
    {#                        {% endif %}#}
    {#                    </tr>#}
    {#                {% else %}#}
    {#                    <tr>#}
    {#                        <td>#}
    {#                            {{ field }}#}
    {#                        </td>#}
    {#                        <td class="empty">Not connected to any {{ field }} items</td>#}
    {#                        <td></td>#}
    {#                    </tr>#}
    {#                {% endif %}#}
    {#            {% endfor %}#}
    {#            </tbody>#}
    {#        </table>#}
    {#    </div>#}
    {#    </div>#}



    <form id="unlink_form" action="{% url 'main:link_remove' %}" method="POST" hidden>
        {% csrf_token %}
        <input type="text" name="unlink_item_type" id="unlink_item_type" value="">
        <input type="text" name="unlink_item_id" id="unlink_item_id" value="">
        <input type="text" name="unlink_related_name" id="unlink_related_name" value="">
        <input type="text" name="unlink_related_id" id="unlink_related_id" value="">
    </form>

    <form id="privacy_form" action="{% url 'main:set_privacy' %}" method='POST' hidden>
        {% csrf_token %}
        <input type="text" name="item_type" id="item_type" value="">
        <input type="text" name="item_id" id="item_id" value="">
        <input type="text" name="privacy_level" id="privacy_level" value="">
    </form>


{% endblock content %}

{% block end_scripts %}
    {{ block.super }}
    <script>
        $(document).ready(function () {
            $("#check_validity").click(function (e) {
                e.preventDefault();
                $.ajax({
                    url: "/validate/{{ item_type }}/{{ item.id }}",
                    success: function (data) {
                        $('#validity_div').removeClass().addClass(data['style']);
                        $('#last_checked').text(data['last_checked']);
                        $('#errors').html(data['errors']);
                    }
                });
            });
        });

        function Unlink(related_name, related_id) {
            $('input[name="unlink_item_type"]').val("{{ item_type }}");
            $('input[name="unlink_item_id"]').val("{{ item.id }}");
            $('input[name="unlink_related_name"]').val(related_name);
            $('input[name="unlink_related_id"]').val(related_id);
            $("form#unlink_form ").submit();
        }

        function SetPrivate() {
            $('input[name="item_type"]').val("{{ item_type }}");
            $('input[name="item_id"]').val("{{ item.id }}");
            $('input[name="privacy_level"]').val("private");
            $("form#privacy_form ").submit();
        }

        function SetPublic() {
            $('input[name="item_type"]').val("{{ item_type }}");
            $('input[name="item_id"]').val("{{ item.id }}");
            $('input[name="privacy_level"]').val("public");
            $("form#privacy_form ").submit();
        }
    </script>


{% endblock end_scripts %}