{% extends 'main/base.html' %}
{% load crispy_forms_tags %}
{% load foe_tags %}

{% block title %}{{ item_type }} <b>{{ item.name }}</b>{% endblock title %}

{% block todo %}{% endblock todo %}

{% block tabs %}
    {{ block.super }}

    <ul class="nav nav-tabs">
        <li class="active"><a data-toggle="tab" href="#tab_information">Summary</a></li>
        {% for field, obj_type, objs, title in data %}
            <li><a data-toggle="tab" href="#tab_{{ field }}">{{ title }}</a></li>
        {% endfor %}
        <li><a data-toggle="tab" href="#tab_validity">Validity and checking</a></li>
    </ul>

{% endblock tabs %}

{% block content %}

    <div class="tab-content">

        <div id="tab_information" class="tab-pane fade in active">
            <br>
            {% if item.notes %}<p>{{ item.notes|linebreaks }}</p>
            {% else %}<p class="empty">No notes provided</p>{% endif %}

            <table class="datatables display table" id="table-information">
                <thead>
                <tr>
                    <th>Name</th>
                    <th>Value</th>
                </tr>
                </thead>
                <tbody>
                {% for field, obj in locals %}
                    <tr>
                        <td>{{ field }}</td>
                        <td>
                            {% if obj %}{{ obj }}
                            {% else %}<p class="empty">None</p>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
                {% for field_name, obj_type, obj, title in present_in %}
                    <tr>
                        <td>
                            {{ title|lower }}
                        </td>
                        <td>
                            {% if obj %}
                                {{ obj.name }}
                            {% else %}
                                <p class="empty">None</p>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}

                <tr>
                    <td>owner</td>
                    <td>
                        {% if item.owner %}{{ item.owner|title }}
                        {% else %}
                            <p class="empty">None</p>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td>provenance</td>
                    <td>
                        {% if item.imported_from %}{{ item.imported_from }}
                        {% else %}
                            <p class="empty">None</p>
                        {% endif %}
                    </td>
                </tr>


                </tbody>
            </table>


        </div>


        {% for field_name, obj_type, objs, title in data %}

            <div id="tab_{{ field_name }}" class="tab-pane fade">
                <br>
                <div class="button_bar">
                    <a onclick="LoadModalData('Include {{ field_name }}',
                            '{% url 'main:link_downstream' item_type=item_type item_id=item.id related_name=field_name %}'
                            );"
                       data-toggle="modal"
                       data-target="#formModal"
                       style="text-decoration: none;">
                        <button class="btn btn-default">
                            <i class="fa fa-chain"></i> Include existing {{ obj_type }}
                        </button>
                    </a>
                    <a href="{% url 'main:create' item_type=obj_type %}" target="_blank">
                        <button id="add_new_{{ obj_type }}" class="btn btn-default">
                            <i class="fa fa-plus"></i> Create a new {{ obj_type }}
                        </button>
                    </a>
                </div>
                <table class="datatables display table table-hover" id="table-{{ obj_type }}" style="width:100%;">
                    <thead>
                    <tr>
                        <th>Name</th>
                        <th>Owner</th>
                        {% if can_edit %}
                            <th>Actions</th>
                        {% endif %}
                    </tr>
                    </thead>
                    <tbody class="rowlink" data-link="row">
                    {% for obj in objs %}
                        <tr class="validity_{{ obj.is_valid }}">
                            <td>
                                <a href="{% url 'main:display' item_type=obj_type item_id=obj.id %}"></a>
                                {{ obj.name }}
                            </td>
                            <td>{{ obj.owner }}</td>
                            {% if can_edit %}
                                <td class="rowlink-skip">
                                    <a onclick="Unlink('{{ field_name }}','{{ obj.id }}');">Unlink</a>
                                </td>
                            {% endif %}
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        {% endfor %}

        <div id="tab_validity" class="tab-pane fade">
            <div class="button_bar">
                <button id="check_validity" class="btn btn-default">
                    <i class="fa fa-refresh"></i> Check again
                </button>

                <button id="refresh_error_tree" class="btn btn-default">
                    <i class="fa fa-refresh"></i> Refresh TODO list
                </button>
            </div>


            <div class="col-sm-12">
                <b>Last checked: </b><span id="last_checked">{{ item.last_checked }}</span>
                <div id="validity_div" class="validity_{{ item.is_valid }}">
                    <div id="errors">
                        {% for e in item.errors.all %}
                            {{ e.spec }}: {{ e.hints|safe }}<br>
                        {% empty %}
                            There are no local validation errors, but downstream entities contain errors.  Use the
                            <i>Show TODO list</i> to see them.
                        {% endfor %}
                    </div>
                </div>

                <h3>Local errors</h3>
                {% if errors %}
                    <table class="display table" id="table-local-errors">
                        <thead>
                        <tr>
                            <th>Specification reference</th>
                            <th>Message</th>
                            <th>Go to item</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for err in errors %}
                            <tr>
                                <td>{{ err.spec }}</td>
                                <td>{{ err.hints|safe }}</td>
                                <td>
                                    <a href="{% url 'main:display' item_type=item_type item_id=item.id %}">
                                        Open <i>{{ item.name }}</i>
                                    </a>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p class="empty">
                        There are no local errors - yay!
                    </p>
                {% endif %}

                <div id="downstream-errors">
                    {% if error_tree %}
                        {{ error_tree|safe }}
                    {% else %}
                        <p class="empty">No downstream errors found</p>
                    {% endif %}

{#                    {% if tree %}#}
{#                        <table class="display table" id="table-downstream-errors">#}
{#                            <thead>#}
{#                            <tr>#}
{#                                <th>Specification reference</th>#}
{#                                <th>Message</th>#}
{#                                <th>Go to item</th>#}
{#                            </tr>#}
{#                            </thead>#}
{#                            <tbody>#}
{#                            {% for child_item, child_type, errors in tree %}#}
{#                                {% for err in errors %}#}
{#                                    <tr>#}
{#                                        <td>{{ err.spec }}</td>#}
{#                                        <td>{{ err.hints|safe }}</td>#}
{#                                        <td>#}
{#                                            <a href="{% url 'main:display' item_type=child_type item_id=child_item.id %}">#}
{#                                                Open <i>{{ child_item.name }}</i>#}
{#                                            </a>#}
{#                                        </td>#}
{#                                    </tr>#}
{#                                {% endfor %}#}
{#                            {% endfor %}#}
{#                            </tbody>#}
{#                        </table>#}
{#                    {% else %}#}
{#                        <p class="empty">#}
{#                            There are no downstream errors - yay!#}
{#                        </p>#}
{#                    {% endif %}#}
                </div>

            </div>
        </div>
    </div>






    <form id="unlink_form" action="{% url 'main:link_remove' %}" method="POST" hidden>
        {% csrf_token %}
        <input type="text" name="unlink_item_type" id="unlink_item_type" value="">
        <input type="text" name="unlink_item_id" id="unlink_item_id" value="">
        <input type="text" name="unlink_related_name" id="unlink_related_name" value="">
        <input type="text" name="unlink_related_id" id="unlink_related_id" value="">
    </form>

    <form id="privacy_form" action="{% url 'main:set_privacy' %}" method='POST' hidden>
        {% csrf_token %}
        <input type="text" name="item_type" id="item_type" value="">
        <input type="text" name="item_id" id="item_id" value="">
        <input type="text" name="privacy_level" id="privacy_level" value="">
    </form>


{% endblock content %}

{% block end_scripts %}
    {{ block.super }}
    <script>
        $(document).ready(function () {
            $("#check_validity").click(function (e) {
                e.preventDefault();
                $.ajax({
                    url: "/validate/{{ item_type }}/{{ item.id }}",
                    success: function (data) {
                        $('#validity_div').removeClass().addClass(data['style']);
                        $('#last_checked').text(data['last_checked']);
                        $('#errors').html(data['errors']);
                    }
                });
            });

            $("#refresh_error_tree").click(function (e) {
                e.preventDefault();
                $.ajax({
                    url: "/refresh_error_tree/{{ item_type }}/{{ item.id }}",
                    success: function (data) {
                        $('#downstream-errors').html(data['tree_html']);
                    }
                });
            });
        });

        function Unlink(related_name, related_id) {
            $('input[name="unlink_item_type"]').val("{{ item_type }}");
            $('input[name="unlink_item_id"]').val("{{ item.id }}");
            $('input[name="unlink_related_name"]').val(related_name);
            $('input[name="unlink_related_id"]').val(related_id);
            $("form#unlink_form ").submit();
        }

        function SetPrivate() {
            $('input[name="item_type"]').val("{{ item_type }}");
            $('input[name="item_id"]').val("{{ item.id }}");
            $('input[name="privacy_level"]').val("private");
            $("form#privacy_form ").submit();
        }

        function SetPublic() {
            $('input[name="item_type"]').val("{{ item_type }}");
            $('input[name="item_id"]').val("{{ item.id }}");
            $('input[name="privacy_level"]').val("public");
            $("form#privacy_form ").submit();
        }
    </script>


{% endblock end_scripts %}