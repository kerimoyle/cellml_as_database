{% extends 'main/base.html' %}
{% load crispy_forms_tags %}
{% load foe_tags %}

{% block title %}{{ item_type }} <b>{{ item.name }}</b>{% endblock title %}

{% block todo %}{% endblock todo %}


{% block tabs %}
    {{ block.super }}
    <ul class="nav nav-tabs">
        <li class="active"><a data-toggle="tab" href="#tab_information">Summary</a></li>
        <li><a data-toggle="tab" href="#tab_validity">Validity and checking</a></li>
        {% for field, obj_type, objs, title, template in data %}
            <li><a data-toggle="tab" href="#tab_{{ field }}">{{ title }}</a></li>
        {% endfor %}
    </ul>
{% endblock tabs %}


{% block content %}
    <div class="tab-content">
        <div id="tab_information" class="tab-pane fade in active">

            <br>
            <div class="col-md-12">{% if item.notes %}<p><b>Notes: </b>{{ item.notes|linebreaks }}</p>
            {% else %}<p class="empty">No notes provided</p>{% endif %}
            </div>

            <div class="col-md-12">
                <table class="datatables display table" id="table-information">
                    <thead>
                    <tr>
                        <th>Name</th>
                        <th>Value</th>
                        <th></th>
                    </tr>
                    </thead>
                    <tbody>

                    {% for field, obj in locals %}
                        <tr>
                            <td>{{ field }}</td>
                            {% if obj is not None %}
                                <td>
                                    {{ obj }}
                                </td>
                                <td>
                                    {% for e in obj.errors.all %}
                                        {{ e }}
                                    {% endfor %}
                                </td>
                            {% else %}
                                <td colspan="2">
                                    <p class="empty">None</p>
                                </td>
                            {% endif %}
                        </tr>
                    {% endfor %}

                    <tr>
                        <td>owner</td>
                        <td colspan="2">
                            {% if item.owner %}{{ item.owner|title }}
                            {% else %}
                                <p class="empty">None</p>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td>provenance</td>
                        <td colspan="2">
                            {% if item.imported_from %}{{ item.imported_from }}
                            {% else %}
                                <p class="empty">None</p>
                            {% endif %}
                        </td>
                    </tr>

                    {% for field_name, obj_type, objs, title in present_in %}
                        <tr class="validity_{{ obj.is_valid }}">
                            <td>
                                {{ title|lower }}
                            </td>
                            <td colspan="2">
                                {% for obj in objs.all %}
                                    <a href="{% url 'main:display' item_type=obj_type item_id=obj.id %}">
                                        <div class="validity_{{ obj.is_valid }}">
                                            {{ obj.name }}
                                        </div>
                                    </a>
                                {% empty %}
                                    <p class="empty">None</p>
                                {% endfor %}
                            </td>
                        </tr>
                    {% endfor %}

                    </tbody>
                </table>
            </div>
        </div>


        <div id="tab_validity" class="tab-pane fade">
            <div class="button_bar">
                <button id="validity_div" class="btn btn-secondary validity_banner_{{ item.is_valid }}">
                    <b>Last checked: </b><span id="last_checked">{{ item.last_checked }}</span>
                </button>

                <button id="check_validity" class="btn btn-default">
                    <i class="fa fa-refresh"></i> Check validity again
                </button>

                <button id="refresh_error_tree" class="btn btn-default">
                    <i class="fa fa-refresh"></i> Refresh TODO list
                </button>
            </div>

            {#            <div class="col-sm-6">#}
            {#                {% if item.errors.all %}#}
            {#                    <table class="display table" id="table-local-errors">#}
            {#                        <thead>#}
            {#                        <tr>#}
            {#                            <th>Specification</th>#}
            {#                            <th>Message</th>#}
            {#                        </tr>#}
            {#                        </thead>#}
            {#                        <tbody>#}
            {#                        {% for err in item.errors.all %}#}
            {#                            <tr>#}
            {#                                <td>{{ err.spec }}</td>#}
            {#                                <td>{{ err.hints|safe }}</td>#}
            {#                            </tr>#}
            {#                        {% endfor %}#}
            {#                        </tbody>#}
            {#                    </table>#}
            {#                {% endif %}#}
            {##}
            {#                <div id="downstream-errors">#}
            {#                    {% if error_tree %}#}
            {#                        {{ error_tree|safe }}#}
            {#                    {% else %}#}
            {#                        <p class="empty">No downstream errors found</p>#}
            {#                    {% endif %}#}
            {#                </div>#}
            {#            </div>#}

            <div class="col-md-12">
                <br>
                <div id="ajax_todo_div"></div>
            </div>

        </div>

        {% for field_name, obj_type, objs, title, template in data %}
            {% include template with field_name=field_name obj_type=obj_type objs=objs title=title %}
        {% endfor %}
    </div>

    <form id="unlink_form" action="{% url 'main:link_remove' %}" method="POST" hidden>
        {% csrf_token %}
        <input type="text" name="unlink_item_type" id="unlink_item_type" value="">
        <input type="text" name="unlink_item_id" id="unlink_item_id" value="">
        <input type="text" name="unlink_related_name" id="unlink_related_name" value="">
        <input type="text" name="unlink_related_id" id="unlink_related_id" value="">
    </form>
    <form id="privacy_form" action="{% url 'main:set_privacy' %}" method='POST' hidden>
        {% csrf_token %}
        <input type="text" name="item_type" id="item_type" value="">
        <input type="text" name="item_id" id="item_id" value="">
        <input type="text" name="privacy_level" id="privacy_level" value="">
    </form>
{% endblock content %}


{% block end_scripts %}
    {{ block.super }}
    {% block datatables %}{% endblock datatables %}
    <script>
        $(document).ready(function () {

            $("#check_validity").click(function (e) {
                e.preventDefault();

                $('#last_checked').text("Checking now ... please wait ...");
                $('#ajax_todo_div').html("Building check list ... please wait ...");
                $('#downstream-errors').html("");

                $.ajax({
                    url: "/ajax_get_validation_list/{{ item_type }}/{{ item.id }}",
                    success: function (data) {
                        // The ajax_todo_div is processed automatically by the ajax queue in ProcessList()

                        $('#ajax_todo_div').html(data.tree);
                        $('#last_checked').text("");
                        ProcessList();
                    }
                });
            });

            {#$("#refresh_error_tree").click(function (e) {#}
            {#    e.preventDefault();#}
            {#    $.ajax({#}
            {#        url: "/refresh_error_tree/{{ item_type }}/{{ item.id }}",#}
            {#        success: function (data) {#}
            {#            $('#downstream-errors').html(data['tree_html']);#}
            {#        }#}
            {#    });#}
            {# });#}
        });

        function ProcessList() {
            // jQuery on an empty object, we are going to use this as our Queue
            let ajaxQueue = $({});
            $.ajaxQueue = function (ajaxOpts) {
                let jqXHR,
                    dfd = $.Deferred(),
                    promise = dfd.promise();
                ajaxQueue.queue(doRequest);
                promise.abort = function (statusText) {
                    if (jqXHR) {
                        return jqXHR.abort(statusText);
                    }
                    let queue = ajaxQueue.queue(),
                        index = $.inArray(doRequest, queue);
                    if (index > -1) {
                        queue.splice(index, 1);
                    }
                    dfd.rejectWith(ajaxOpts.context || ajaxOpts,
                        [promise, statusText, ""]);
                    return promise;
                };

                function doRequest(next) {
                    jqXHR = $.ajax(ajaxOpts)
                        .then(next, next)
                        .done(dfd.resolve)
                        .fail(dfd.reject);
                }

                return promise;
            };

            $(".validity_list_waiting").each(function (e) {
                let my_split = $(this).attr('id').split('__');

                $.ajaxQueue({
                    url: '/ajax_validate/',
                    data: {
                        item_type: my_split[0],
                        item_id: my_split[1],
                    },
                    type: 'GET',
                    context: this,
                    success: function (data) {
                        $(this).fadeOut();
                        $("#todo_tbody_parent").append(data['tree']);
                    }
                });
            });
        }

        function Unlink(related_name, related_id) {
            $('input[name="unlink_item_type"]').val("{{ item_type }}");
            $('input[name="unlink_item_id"]').val("{{ item.id }}");
            $('input[name="unlink_related_name"]').val(related_name);
            $('input[name="unlink_related_id"]').val(related_id);
            $("form#unlink_form ").submit();
        }

        function SetPrivate() {
            $('input[name="item_type"]').val("{{ item_type }}");
            $('input[name="item_id"]').val("{{ item.id }}");
            $('input[name="privacy_level"]').val("private");
            $("form#privacy_form ").submit();
        }

        function SetPublic() {
            $('input[name="item_type"]').val("{{ item_type }}");
            $('input[name="item_id"]').val("{{ item.id }}");
            $('input[name="privacy_level"]').val("public");
            $("form#privacy_form ").submit();
        }

        {#(function ($) {#}
        {#    // jQuery on an empty object, we are going to use this as our Queue#}
        {#    let ajaxQueue = $({});#}
        {#    $.ajaxQueue = function (ajaxOpts) {#}
        {#        let jqXHR,#}
        {#            dfd = $.Deferred(),#}
        {#            promise = dfd.promise();#}
        {#        ajaxQueue.queue(doRequest);#}
        {#        promise.abort = function (statusText) {#}
        {#            if (jqXHR) {#}
        {#                return jqXHR.abort(statusText);#}
        {#            }#}
        {#            let queue = ajaxQueue.queue(),#}
        {#                index = $.inArray(doRequest, queue);#}
        {#            if (index > -1) {#}
        {#                queue.splice(index, 1);#}
        {#            }#}
        {#            dfd.rejectWith(ajaxOpts.context || ajaxOpts,#}
        {#                [promise, statusText, ""]);#}
        {#            return promise;#}
        {#        };#}
        {#        function doRequest(next) {#}
        {#            jqXHR = $.ajax(ajaxOpts)#}
        {#                .then(next, next)#}
        {#                .done(dfd.resolve)#}
        {#                .fail(dfd.reject);#}
        {#        }#}
        {#        return promise;#}
        {#    };#}
        {# })(jQuery);#}

        // get each item we want to copy
        {#$("#ajax_todo_list li").each(function (e) {#}
        {#    alert('hi');#}
        {#    let my_split = $(this).attr('id').split('__');#}
        {#    alert(my_split[0]);#}
        {#    alert(my_split[1]);#}
        {#    $.ajaxQueue({#}
        {#        url: '/main/ajax_validate/',#}
        {#        data: {#}
        {#            item_type: my_split[0],#}
        {#            item_id: my_split[1],#}
        {#        },#}
        {#        type: 'GET',#}
        {#        context: this,#}
        {#        success: function (data) {#}
        {#            $(this).addClass(data.style);#}
        {#$(this).html(data.messages);#}
        {#        }#}
        {#    });#}
        {# });#}
    </script>
{% endblock end_scripts %}